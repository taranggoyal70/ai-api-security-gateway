<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agent Security Gateway - Live Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        [v-cloak] { display: none; }
        .security-event {
            animation: slideIn 0.3s ease-out;
        }
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        .pulse-dot {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: .5;
            }
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100">
    <div id="app" v-cloak>
        <!-- Header -->
        <header class="bg-gray-800 border-b border-gray-700 shadow-lg">
            <div class="container mx-auto px-6 py-4">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-4">
                        <div class="text-3xl">üõ°Ô∏è</div>
                        <div>
                            <h1 class="text-2xl font-bold text-white">Agent Security Gateway</h1>
                            <p class="text-sm text-gray-400">Real-Time API Security System</p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-4">
                        <div class="flex items-center space-x-2">
                            <div :class="wsConnected ? 'bg-green-500' : 'bg-red-500'" class="w-3 h-3 rounded-full pulse-dot"></div>
                            <span class="text-sm text-gray-300">{{ wsConnected ? 'Live' : 'Disconnected' }}</span>
                        </div>
                        <div class="text-sm text-gray-400">
                            Total Requests: <span class="font-bold text-white">{{ stats.total_requests }}</span>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <div class="container mx-auto px-6 py-8">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                
                <!-- Left Column: Testing Playground -->
                <div class="lg:col-span-1 space-y-6">
                    <!-- Agent Playground -->
                    <div class="bg-gray-800 rounded-lg shadow-xl p-6 border border-gray-700">
                        <h2 class="text-xl font-bold mb-4 flex items-center">
                            <span class="text-2xl mr-2">üéÆ</span>
                            Agent Playground
                        </h2>
                        
                        <!-- Agent Selection -->
                        <div class="mb-4">
                            <label class="block text-sm font-medium mb-2">Agent ID</label>
                            <select v-model="testRequest.agentId" class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white">
                                <option value="support-bot">support-bot (Limited)</option>
                                <option value="finance-bot">finance-bot (Finance)</option>
                                <option value="admin-agent">admin-agent (Full Access)</option>
                                <option value="demo-agent">demo-agent (Demo Only)</option>
                                <option value="hacker-bot">hacker-bot (Unknown)</option>
                            </select>
                        </div>

                        <!-- Endpoint Selection -->
                        <div class="mb-4">
                            <label class="block text-sm font-medium mb-2">Endpoint</label>
                            <select v-model="testRequest.endpoint" class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white">
                                <option value="/tickets">üé´ /tickets</option>
                                <option value="/refunds">üí∞ /refunds</option>
                                <option value="/invoices">üìÑ /invoices</option>
                                <option value="/export">üìä /export</option>
                                <option value="/sync/safe">‚úÖ /sync/safe</option>
                            </select>
                        </div>

                        <!-- Test Scenarios -->
                        <div class="mb-4">
                            <label class="block text-sm font-medium mb-2">Test Scenario</label>
                            <select v-model="selectedScenario" @change="loadScenario" class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white">
                                <option value="valid">‚úÖ Valid Request</option>
                                <option value="schema">‚ùå Schema Violation</option>
                                <option value="identity">‚ùå Identity Violation</option>
                                <option value="guardrail">‚ùå Guardrail Violation</option>
                                <option value="taint">‚ö†Ô∏è Tainted Data</option>
                                <option value="rate">‚è±Ô∏è Rate Limit Test</option>
                            </select>
                        </div>

                        <!-- Parameters -->
                        <div class="mb-4">
                            <label class="block text-sm font-medium mb-2">Parameters (JSON)</label>
                            <textarea v-model="testRequest.paramsJson" rows="4" class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white font-mono text-sm"></textarea>
                        </div>

                        <!-- User Prompt -->
                        <div class="mb-4">
                            <label class="block text-sm font-medium mb-2">User Prompt (Optional)</label>
                            <input v-model="testRequest.userPrompt" type="text" class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white" placeholder="e.g., Refund customer 123 $250">
                        </div>

                        <!-- Send Button -->
                        <button @click="sendTestRequest" :disabled="sending" class="w-full bg-blue-600 hover:bg-blue-700 disabled:bg-gray-600 text-white font-bold py-3 px-4 rounded transition duration-200">
                            {{ sending ? '‚è≥ Sending...' : 'üöÄ Send Request' }}
                        </button>
                    </div>

                    <!-- Stats Card -->
                    <div class="bg-gray-800 rounded-lg shadow-xl p-6 border border-gray-700">
                        <h2 class="text-xl font-bold mb-4 flex items-center">
                            <span class="text-2xl mr-2">üìä</span>
                            Statistics
                        </h2>
                        <div class="space-y-3">
                            <div class="flex justify-between items-center">
                                <span class="text-gray-400">Total Requests:</span>
                                <span class="font-bold text-white">{{ stats.total_requests }}</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-gray-400">Allowed:</span>
                                <span class="font-bold text-green-400">{{ stats.allowed }}</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-gray-400">Blocked:</span>
                                <span class="font-bold text-red-400">{{ stats.blocked }}</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-gray-400">Block Rate:</span>
                                <span class="font-bold text-yellow-400">{{ stats.block_rate.toFixed(1) }}%</span>
                            </div>
                        </div>
                        
                        <div class="mt-4 pt-4 border-t border-gray-700">
                            <h3 class="text-sm font-semibold mb-2 text-gray-300">Blocks by Control</h3>
                            <div class="space-y-2">
                                <div v-for="(count, control) in stats.blocks_by_control" :key="control" class="flex justify-between items-center text-sm">
                                    <span class="text-gray-400">{{ formatControlName(control) }}:</span>
                                    <span class="font-bold text-red-400">{{ count }}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Right Column: Live Events & Response -->
                <div class="lg:col-span-2 space-y-6">
                    <!-- Last Response -->
                    <div v-if="lastResponse" class="bg-gray-800 rounded-lg shadow-xl p-6 border border-gray-700">
                        <h2 class="text-xl font-bold mb-4 flex items-center">
                            <span class="text-2xl mr-2">{{ lastResponse.allowed ? '‚úÖ' : '‚ùå' }}</span>
                            Last Response
                        </h2>
                        
                        <div class="space-y-4">
                            <!-- Decision -->
                            <div class="p-4 rounded" :class="lastResponse.allowed ? 'bg-green-900/30 border border-green-700' : 'bg-red-900/30 border border-red-700'">
                                <div class="flex items-center justify-between">
                                    <span class="font-bold text-lg">{{ lastResponse.allowed ? 'ALLOWED' : 'BLOCKED' }}</span>
                                    <span v-if="!lastResponse.allowed" class="text-sm text-red-300">by {{ lastResponse.blocked_by }}</span>
                                </div>
                                <p v-if="lastResponse.reason" class="mt-2 text-sm text-gray-300">{{ lastResponse.reason }}</p>
                            </div>

                            <!-- Security Checks -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                <div v-for="(check, control) in lastResponse.security_checks" :key="control" class="p-3 bg-gray-700 rounded border" :class="check.passed ? 'border-green-600' : 'border-red-600'">
                                    <div class="flex items-center justify-between mb-1">
                                        <span class="text-sm font-semibold">{{ formatControlName(control) }}</span>
                                        <span class="text-lg">{{ check.passed ? '‚úÖ' : '‚ùå' }}</span>
                                    </div>
                                    <p class="text-xs text-gray-400">{{ check.details || 'N/A' }}</p>
                                </div>
                            </div>

                            <!-- Request Details -->
                            <details class="bg-gray-700 rounded p-3">
                                <summary class="cursor-pointer font-semibold text-sm">Request Details</summary>
                                <pre class="mt-2 text-xs text-gray-300 overflow-x-auto">{{ JSON.stringify(lastResponse, null, 2) }}</pre>
                            </details>
                        </div>
                    </div>

                    <!-- Live Security Events -->
                    <div class="bg-gray-800 rounded-lg shadow-xl p-6 border border-gray-700">
                        <div class="flex items-center justify-between mb-4">
                            <h2 class="text-xl font-bold flex items-center">
                                <span class="text-2xl mr-2">üì°</span>
                                Live Security Events
                            </h2>
                            <button @click="clearEvents" class="text-sm text-gray-400 hover:text-white">Clear</button>
                        </div>

                        <div class="space-y-3 max-h-96 overflow-y-auto">
                            <div v-if="events.length === 0" class="text-center text-gray-500 py-8">
                                No events yet. Send a test request to see live monitoring.
                            </div>
                            
                            <div v-for="event in events" :key="event.request_id" class="security-event p-4 bg-gray-700 rounded border-l-4" :class="event.allowed ? 'border-green-500' : 'border-red-500'">
                                <div class="flex items-start justify-between">
                                    <div class="flex-1">
                                        <div class="flex items-center space-x-2 mb-1">
                                            <span class="text-lg">{{ event.allowed ? '‚úÖ' : '‚ùå' }}</span>
                                            <span class="font-semibold">{{ event.agent_id }}</span>
                                            <span class="text-sm text-gray-400">‚Üí</span>
                                            <span class="text-sm text-blue-400">{{ event.request_data.endpoint }}</span>
                                        </div>
                                        <p class="text-sm text-gray-300">{{ event.reason }}</p>
                                        <div v-if="!event.allowed" class="mt-1">
                                            <span class="text-xs bg-red-900/50 text-red-300 px-2 py-1 rounded">{{ event.blocked_by }}</span>
                                        </div>
                                    </div>
                                    <span class="text-xs text-gray-500">{{ formatTime(event.timestamp) }}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { createApp } = Vue;

        createApp({
            data() {
                return {
                    wsConnected: false,
                    ws: null,
                    sending: false,
                    events: [],
                    lastResponse: null,
                    stats: {
                        total_requests: 0,
                        allowed: 0,
                        blocked: 0,
                        block_rate: 0,
                        blocks_by_control: {}
                    },
                    testRequest: {
                        agentId: 'support-bot',
                        endpoint: '/tickets',
                        paramsJson: '{"customer_id": "123", "subject": "Help needed"}',
                        userPrompt: ''
                    },
                    selectedScenario: 'valid'
                };
            },
            mounted() {
                this.connectWebSocket();
                this.loadStats();
                setInterval(() => this.loadStats(), 5000);
            },
            methods: {
                connectWebSocket() {
                    this.ws = new WebSocket('ws://localhost:8002/ws/events');
                    
                    this.ws.onopen = () => {
                        this.wsConnected = true;
                        console.log('WebSocket connected');
                    };
                    
                    this.ws.onmessage = (event) => {
                        const data = JSON.parse(event.data);
                        if (data.type === 'history') {
                            this.events = data.events.reverse();
                        } else {
                            this.events.unshift(data);
                            if (this.events.length > 50) {
                                this.events.pop();
                            }
                        }
                    };
                    
                    this.ws.onclose = () => {
                        this.wsConnected = false;
                        console.log('WebSocket disconnected, reconnecting...');
                        setTimeout(() => this.connectWebSocket(), 3000);
                    };
                },
                
                async loadStats() {
                    try {
                        const response = await axios.get('http://localhost:8002/stats');
                        this.stats = response.data;
                    } catch (error) {
                        console.error('Failed to load stats:', error);
                    }
                },
                
                async sendTestRequest() {
                    this.sending = true;
                    try {
                        const params = JSON.parse(this.testRequest.paramsJson);
                        
                        const payload = {
                            endpoint: this.testRequest.endpoint,
                            method: 'GET',
                            params: params,
                            user_prompt: this.testRequest.userPrompt || null
                        };
                        
                        const response = await axios.post(
                            'http://localhost:8002/gateway/secure',
                            payload,
                            {
                                headers: {
                                    'X-Agent-ID': this.testRequest.agentId
                                }
                            }
                        );
                        
                        this.lastResponse = response.data;
                        await this.loadStats();
                    } catch (error) {
                        console.error('Request failed:', error);
                        alert('Request failed: ' + error.message);
                    } finally {
                        this.sending = false;
                    }
                },
                
                loadScenario() {
                    const scenarios = {
                        valid: {
                            agentId: 'support-bot',
                            endpoint: '/tickets',
                            paramsJson: '{"customer_id": "123", "subject": "Help needed"}',
                            userPrompt: ''
                        },
                        schema: {
                            agentId: 'support-bot',
                            endpoint: '/tickets',
                            paramsJson: '{"customer_id": "123", "subject": "Help", "override_checks": true}',
                            userPrompt: ''
                        },
                        identity: {
                            agentId: 'support-bot',
                            endpoint: '/invoices',
                            paramsJson: '{"customer_id": "123", "amount": 100}',
                            userPrompt: ''
                        },
                        guardrail: {
                            agentId: 'support-bot',
                            endpoint: '/refunds',
                            paramsJson: '{"customer_id": "123", "amount": 5000}',
                            userPrompt: 'Refund customer 123 $5000'
                        },
                        taint: {
                            agentId: 'support-bot',
                            endpoint: '/refunds',
                            paramsJson: '{"customer_id": "123", "amount": 250}',
                            userPrompt: 'Refund customer 123 $250'
                        },
                        rate: {
                            agentId: 'support-bot',
                            endpoint: '/refunds',
                            paramsJson: '{"customer_id": "123", "amount": 50}',
                            userPrompt: ''
                        }
                    };
                    
                    const scenario = scenarios[this.selectedScenario];
                    if (scenario) {
                        Object.assign(this.testRequest, scenario);
                    }
                },
                
                clearEvents() {
                    this.events = [];
                },
                
                formatControlName(control) {
                    return control.split('_').map(word => 
                        word.charAt(0).toUpperCase() + word.slice(1)
                    ).join(' ');
                },
                
                formatTime(timestamp) {
                    const date = new Date(timestamp);
                    return date.toLocaleTimeString();
                }
            }
        }).mount('#app');
    </script>
</body>
</html>
